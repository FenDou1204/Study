# IPv6中icmpv6以及邻居协议nd

## ICMPv6
ICMP(Internet控制消息协议)，报告数据包发送中的错误，以及提供简单的echo服务。

icmpv6主要用于两种功能: 
  
- **1. 邻居节点发现(ND)(对应arp协议)**   
- **2. 组播侦听发现(MLD)(对应IGMP协议)**

### ICMPv6消息类型
- 错误消息(Type字段0-127)
- 信息类信息(Type字段128-255)

### ICMPv6头部
IP数据包中**Next Header被设置为ICMPv6（58）**，代表为icmp数据包。

icmp头部中主要有:

- **类型(Type)**:即上述ICMPv6消息类型
- **代码(Code)**:区分某个特定类型信息中的多条信息
- **校验和(Checksum)**：消息的校验和

### ICMPv6错误类消息
- 目标不可达(消息类型1)
- 数据包过大(2)
- 超时(3)
- 参数问题(4)

### ICMPv6信息类消息
- Echo请求(消息类型128)
- Echo应答(消息类型129)

**echo请求也可以发送到组播地址(RFC 4443),但是目前windows8及以前版本不支持此操作**

## 邻居发现
RFC4861定义了ND协议方法。ND取代了ARP和ICMP路由发现协议。
邻居发现消息主要有5种不同的类型:
- 路由器请求消息(133)
- 路由器通告消息(134)
- 邻居请求消息(135)
- 邻居通告消息(136)
- 重定向消息(137)

我们先主要关注邻居请求消息和邻居通告消息。

### 邻居请求消息
- 目的:为了发现链路上ipv6节点的链路地址，或者为了确认先前的链路层地址。
- 请求地址解析使用组播进行发送
- 确认节点可达性使用单播进行发送

![使用组播地址发送的ns](https://github.com/GrapeSky04/picture/blob/master/ipv6/ns_request.jpg?raw=true)

### 邻居应答消息
- 被动情况使用单播地址进行回应
- 主动情况使用组播地址进行回应，目的mac被设置为33:33:00:00:00:01
![使用单播地址回复的nd](https://github.com/GrapeSky04/picture/blob/master/ipv6/nd_response.jpg?raw=true)